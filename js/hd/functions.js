/**
 * Created by OChernikov on 06.07.2017.
 */

 bras_no_policy={"264":"","149":"","107":"","69":"vpn7.arkhangelsk.golden.ru","252":"vpn7.arkhangelsk.golden.ru","249":"vpn7.arkhangelsk.golden.ru","250":"vpn7.arkhangelsk.golden.ru","251":"vpn7.arkhangelsk.golden.ru","241":"vpn7.arkhangelsk.golden.ru","253":"vpn7.arkhangelsk.golden.ru","41":"bras2.ast.corbina.net","208":"","179":"","175":"","183":"","177":"","178":"","181":"","182":"","176":"","180":"","55":"bras1.brn.corbina.net","219":"","85":"","108":"","109":"","16":"bras1.vlg.corbina.net","135":"bras1.vlg.corbina.net","6":"bras1.vlg.corbina.net","262":"bras1.vlg.corbina.net","137":"vpn2.vologda.golden.ru","246":"vpn2.vologda.golden.ru","240":"vpn2.vologda.golden.ru","207":"vpn2.vologda.golden.ru","73":"vpn252.voronezh.golden.ru","140":"vpn252.voronezh.golden.ru","185":"vpn252.voronezh.golden.ru","193":"vpn252.voronezh.golden.ru","87":"bras1.nnov.corbina.net","84":"bras2.ekat.corbina.net","146":"","45":"","46":"","99":"","32":"","139":"","266":"","81":"","144":"","145":"","128":"","89":"bras7.kazan.corbina.net","70":"asr1.kaliningrad.golden.ru","13002":"asr1.kaliningrad.golden.ru","13006":"asr1.kaliningrad.golden.ru","7":"bras1.klg.corbina.net","233":"bras1.klg.corbina.net","232":"bras1.klg.corbina.net","260":"bras1.klg.corbina.net","141":"bras1.klg.corbina.net","124":"","79":"vpn2.kemerovo.golden.ru","121":"vpn2.kemerovo.golden.ru","120":"","190":"bras1.kst.corbina.net","191":"bras1.kst.corbina.net","102":"bras1.kst.corbina.net","51":"bras1.kst.corbina.net","103":"bras1.kst.corbina.net","198":"bras1.kst.corbina.net","83":"vpn1.krasnodar.golden.ru","122":"vpn1.krasnodar.golden.ru","74":"bras2.krn.corbina.net","126":"bras2.krn.corbina.net","164":"bras2.krn.corbina.net","125":"bras2.krn.corbina.net","123":"","65":"bras1.kur.corbina.net","31":"bras1.kur.corbina.net","37":"bras1.kur.corbina.net","813":"bras254.spb.corbina.net","188":"bras254.spb.corbina.net","40":"bras254.spb.corbina.net","192":"bras254.spb.corbina.net","204":"bras254.spb.corbina.net","101":"bras254.spb.corbina.net","206":"bras254.spb.corbina.net","248":"bras254.spb.corbina.net","214":"bras254.spb.corbina.net","223":"bras254.spb.corbina.net","263":"bras254.spb.corbina.net","257":"bras1.lip.corbina.net","138":"bras1.lip.corbina.net","90":"bras97.msk.corbina.net","58":"bras97.msk.corbina.net","56":"bras97.msk.corbina.net","68":"bras97.msk.corbina.net","57":"bras97.msk.corbina.net","59":"bras97.msk.corbina.net","91":"bras97.msk.corbina.net","96":"bras97.msk.corbina.net","270":"bras97.msk.corbina.net","258":"bras97.msk.corbina.net","229":"bras97.msk.corbina.net","227":"bras97.msk.corbina.net","230":"bras97.msk.corbina.net","228":"bras97.msk.corbina.net","166":"bras97.msk.corbina.net","269":"bras97.msk.corbina.net","61":"bras97.msk.corbina.net","226":"bras97.msk.corbina.net","11":"bras97.msk.corbina.net","25":"bras97.msk.corbina.net","98":"bras97.msk.corbina.net","60":"bras97.msk.corbina.net","236":"bras97.msk.corbina.net","150":"bras97.msk.corbina.net","17":"bras97.msk.corbina.net","151":"bras97.msk.corbina.net","152":"bras97.msk.corbina.net","14":"bras97.msk.corbina.net","18":"bras97.msk.corbina.net","29":"bras97.msk.corbina.net","186":"bras97.msk.corbina.net","19":"bras97.msk.corbina.net","153":"bras97.msk.corbina.net","154":"bras97.msk.corbina.net","5":"bras97.msk.corbina.net","97":"bras97.msk.corbina.net","155":"bras97.msk.corbina.net","234":"bras97.msk.corbina.net","8":"bras97.msk.corbina.net","44":"bras97.msk.corbina.net","20":"bras97.msk.corbina.net","156":"bras97.msk.corbina.net","12":"bras97.msk.corbina.net","62":"bras97.msk.corbina.net","23":"bras97.msk.corbina.net","243":"bras97.msk.corbina.net","157":"bras97.msk.corbina.net","235":"bras97.msk.corbina.net","158":"bras97.msk.corbina.net","159":"bras97.msk.corbina.net","160":"bras97.msk.corbina.net","162":"bras97.msk.corbina.net","194":"bras97.msk.corbina.net","224":"bras97.msk.corbina.net","15":"bras97.msk.corbina.net","161":"bras97.msk.corbina.net","27":"bras97.msk.corbina.net","163":"bras97.msk.corbina.net","22":"bras97.msk.corbina.net","225":"bras97.msk.corbina.net","105":"bras97.msk.corbina.net","237":"bras97.msk.corbina.net","238":"bras97.msk.corbina.net","95":"bras97.msk.corbina.net","92":"bras97.msk.corbina.net","9":"bras97.msk.corbina.net","21":"bras97.msk.corbina.net","239":"bras97.msk.corbina.net","12042":"bras97.msk.corbina.net","268":"bras97.msk.corbina.net","127":"bras1.murm.corbina.net","171":"bras1.murm.corbina.net","174":"bras1.murm.corbina.net","173":"bras1.murm.corbina.net","172":"bras1.murm.corbina.net","170":"bras1.murm.corbina.net","76":"","210":"bras1.nnov.corbina.net","231":"bras1.nnov.corbina.net","93":"bras1.nnov.corbina.net","82":"bras1.nnov.corbina.net","136":"bras1.nnov.corbina.net","54":"bras1.omsk.corbina.net","78":"vpn252.orel.golden.ru","2":"","197":"","104":"vpn252.orel.golden.ru","220":"vpn252.orel.golden.ru","13005":"","42":"bras2.perm.corbina.net","200":"bras2.perm.corbina.net","148":"","203":"","129":"","28":"bras5.btsk.corbina.net","130":"bras5.btsk.corbina.net","131":"bras5.btsk.corbina.net","244":"bras5.btsk.corbina.net","863":"bras5.btsk.corbina.net","261":"bras5.btsk.corbina.net","110":"","71":"asr1.samara.golden.ru","201":"vpn254.togliatti.golden.ru","1":"bras254.spb.corbina.net","184":"bras254.spb.corbina.net","195":"bras254.spb.corbina.net","168":"bras254.spb.corbina.net","209":"bras254.spb.corbina.net","167":"bras254.spb.corbina.net","187":"bras254.spb.corbina.net","199":"bras254.spb.corbina.net","189":"bras254.spb.corbina.net","205":"bras254.spb.corbina.net","48":"bras24.srt.corbina.net","196":"bras24.srt.corbina.net","36":"bras24.srt.corbina.net","8452":"bras24.srt.corbina.net","247":"bras24.srt.corbina.net","216":"","169":"bras2.ekat.corbina.net","116":"bras2.ekat.corbina.net","117":"bras2.ekat.corbina.net","119":"bras2.ekat.corbina.net","118":"bras2.ekat.corbina.net","100":"bras2.ekat.corbina.net","215":"bras2.ekat.corbina.net","106":"bras2.ekat.corbina.net","13001":"bras2.ekat.corbina.net","86":"vpn1.severodvinsk.golden.ru","245":"bras1.sml.corbina.net","38":"bras1.sml.corbina.net","33":"bras1.sml.corbina.net","259":"bras1.sml.corbina.net","88":"bras3.sochi.corbina.net","52":"bras1.stv.corbina.net","47":"bras1.stv.corbina.net","53":"bras1.stv.corbina.net","254":"bras1.stv.corbina.net","218":"bras1.stv.corbina.net","132":"bras1.stv.corbina.net","133":"bras1.stv.corbina.net","256":"bras1.stv.corbina.net","49":"bras1.stv.corbina.net","242":"bras1.stv.corbina.net","134":"","165":"bras7.kazan.corbina.net","211":"bras7.kazan.corbina.net","213":"bras7.kazan.corbina.net","212":"bras7.kazan.corbina.net","142":"bras1.tver.corbina.net","143":"bras1.tver.corbina.net","26":"bras1.tver.corbina.net","10":"","72":"vpn254.togliatti.golden.ru","64":"","63":"bras1.tul.corbina.net","30":"bras1.tul.corbina.net","43":"bras1.tul.corbina.net","35":"bras1.tul.corbina.net","39":"bras1.tul.corbina.net","4":"bras1.tul.corbina.net","267":"bras1.tul.corbina.net","66":"bras253.tmn.corbina.net","222":"","221":"","24":"bras1.ul.corbina.net","8422":"bras1.ul.corbina.net","75":"","80":"vpn1.khabarovsk.golden.ru","147":"vpn1.khabarovsk.golden.ru","202":"vpn1.khabarovsk.golden.ru","111":"","114":"vpn1.chelyabinsk.golden.ru","113":"vpn1.chelyabinsk.golden.ru","115":"vpn1.chelyabinsk.golden.ru","217":"vpn1.chelyabinsk.golden.ru","77":"vpn254.cherepovets.golden.ru","112":"","94":"bras1.sskh.corbina.net","50":"bras15.yar.corbina.net","34":"bras15.yar.corbina.net","255":"bras15.yar.corbina.net","3":"bras15.yar.corbina.net","13000":"bras15.yar.corbina.net","265":"bras15.yar.corbina.net","13":""};

//                                      //
//         Hlpdesk requests             //
//                                      //

function get_address_id(url=window.location.href) {
  address_id = url.match(/(address_id=|address\/)([\d]+)/)
  return (address_id === null ? 0 : address_id[2])
}

function get_ticket_id(url=window.location.href) {
  ticket_id = url.match(/(ticket_id=|ticket\/)([\d]+)/)
  return (ticket_id === null ? 0 : ticket_id[2])
}

async function hd_query(url, method="GET", postdata=false, retry=0) {
  if (!postdata && retry < 3) {
    data = loadData(url);
    if (data) {
      return data;
    } else {
      await sleep(350 + Math.floor(Math.random()*300));
      return await hd_query(url, method, postdata, retry+1);
    }
  } else {
    return hd_query_force(url, method, postdata);
  }
}

async function hd_query_force(url, method="GET", postdata=false) {
  opt = {method: method, credentials: 'include'};
  if (method == "GET") {
    opt['headers'] = {'Content-Type': 'text/plain'};
  } else {
    opt['headers'] = {'Content-Type': 'application/json;charset=UTF-8'};
    opt['body'] = JSON.stringify(postdata);
  }
  let req = await fetch(url, opt);
  let res = await req.text();
  try {res = JSON.parse(res)} catch(e){/* We don't care about non-JSON */};
  if (method == "GET") {saveData(url, res)};
  return res;
}

async function getAllUrls(urls, force=false) {
  try {
    var data = await Promise.all(urls.map(
      url => (force ? hd_query_force(url) : hd_query(url))
    ));
    return (data)
  } catch(e) {throw(e)}
}

async function resetContract_new(force=false) {
  address_id = get_address_id();
  ticket_id = get_ticket_id();

  let data = await getAllUrls([
    '/ptn/main_page/abon_info/'+address_id+'/',
    '/ptn/tickets/address/tickets/list/'+address_id
  ], force)

  aboninfo = data[0];
  tickets = data[1];

  contract_statuses = {
    0: 'Активен',
    1: 'Финансовая блокировка',
    2: 'Добровольная блокировка',
    3: 'Заблокирован при регистрации',
    4: 'Административная блокировка',
    5: 'Расторгнут',
    6: 'Расторгнут (Collection)',
    100: 'Активен',
    101: 'Финансовая блокировка',
    102: 'Добровольная блокировка',
    104: 'Административная блокировка'
  }

  var contract = {
    '_group': localStorage.operatorGroup,
    'address': {
      'name': `${aboninfo["address_info_data"]["ct_city"]}, ${aboninfo["address_info_data"]["ar_name"]}, ${aboninfo["address_info_data"]["st_type"]} ${aboninfo["address_info_data"]["s_street"]}, д. ${aboninfo["address_info_data"]["h_house"]}${aboninfo["address_info_data"]["h_building"] ? `,корп. ${aboninfo["address_info_data"]["h_building"]}` : ''}, кв. ${aboninfo["address_info_data"]["a_flat"]}`,
      'id': aboninfo["address_info_data"]["a_id"],
      'city': {'id': aboninfo["address_info_data"]["city"]["ct_id"], 'name': aboninfo["address_info_data"]["city"]["ct_city"], 'shortname': aboninfo["address_info_data"]["city"]["ct_city"].split(',')[0].split(' ')[0]},
      'house': {'id': aboninfo["address_info_data"]["house"]["h_id"], 'name': aboninfo["address_info_data"]["house"]["h_house"], 'building': aboninfo["address_info_data"]["house"]["h_building"]},
      'street': {'id': aboninfo["address_info_data"]["house"]["street"]["s_id"], 'name': aboninfo["address_info_data"]["house"]["street"]["s_street"]},
      'flat': aboninfo["address_info_data"]["a_flat"],
      'tech_area': aboninfo["address_info_data"]["h_dealer"]
    },
    'phones': {
      'all': aboninfo["address_info_data"]["a_phones"],
      'sms': aboninfo["contract_data"]["c_sms_warnto"],
      'conv': aboninfo["contract_data"]["conv_phone"]
    },
    'time_shift': aboninfo["address_info_data"]["city"]["ct_time_shift"],
    'sms_templates': {'other': {}},
    'latest_session': aboninfo["contract_data"]["c_inf"]["ci_last_logon"],
    'tickets': {'selected': ticket_id, 'connectionRequestColor': {'id': 0, 'color': 'grey-color', 'tooltip': 'Заявка не найдена!'}}
  }

  // phones fix - GVNO
  let sms_number_is_in_phones_all = false; // assume that
  for (var i = 0; i < contract["phones"]["all"].length; i++) {
    if (contract["phones"]["all"][i]["phones"] == contract["phones"]["sms"]) {
      sms_number_is_in_phones_all = true;
    }
  }
  if (!sms_number_is_in_phones_all) {
    contract["phones"]["all"].push({'phones': contract["phones"]["sms"]});
  };

  // login data fix - GVNO
  if (aboninfo["login_data"] != null) {
    contract['contract'] = {
      'id': aboninfo["contract_data"]["c_id"],
      'fio': aboninfo["contract_data"]["c_bill_name"],
      'ctn': aboninfo["login_data"]["ctn"],
      'alias': aboninfo["login_data"]["l_login"],
      'regdate': aboninfo["contract_data"]["c_regdate"],
      'billing': {
        'cycle': aboninfo["login_data"]["billing_cycle"],
        'balance': aboninfo["login_data"]["price_next_bc"]["balance"],
        'needed': aboninfo["login_data"]["price_next_bc"]["price"],
      },
      'status': {
        'name': contract_statuses[aboninfo["login_data"]["l_block_type"]],
        'date': aboninfo["login_data"]["l_last_block_date"]
      }
    }
  } else {
    contract['contract'] = {
      'id': aboninfo["contract_data"]["c_id"],
      'fio': aboninfo["contract_data"]["c_bill_name"],
      'ctn': aboninfo["contract_data"]["fvno_vk"]["abon_id"],
      'alias': aboninfo["contract_data"]["fvno_vk"]["abon_id"],
      'regdate': aboninfo["contract_data"]["c_regdate"],
      'fvno': true,
      'billing': {'cycle': 0, 'balance': 0, 'needed': 0,},
      'status': {'name': 'Абонент Партнера', 'date': 0}
    }

    contract["greentable"] = {
      'contype': 'fvno',
      'echelon': '0',
      'ip': aboninfo["contract_data"]["fvno_vk"]["commutator_ip"],
      'mac': aboninfo["contract_data"]["fvno_vk"]["commutator_mac"],
      'port': aboninfo["contract_data"]["fvno_vk"]["commutator_port"],
      'agg': '0.0.0.0',
      'gate': 0,
      'dns': '0.0.0.0 0.0.0.0'
    }

    contract['session'] = {
      'sesstype': 'fvno',
      'online': 0,
      'ip': {
        'bras': '0.0.0.0',
        'local': '0.0.0.0',
        'ext': '0.0.0.0'
      },
      'time': {
        'start': 0,
        'update': 0,
        'duration': 0
      }
    }
  }


  for (i in tickets) {
    contract['tickets'][tickets[i]["t_id"]] = {
      'number': tickets[i]["t_number"],
      'queue': tickets[i]["status"]["queue"],
      'operator': tickets[i]["responsible"],
      'status': {
          'id': tickets[i]["status"]["id"],
          'name': tickets[i]["status"]["name"]
      },
      'type': {
          'id': tickets[i]["type"]["id"],
          'name': tickets[i]["type"]["name"]
      },
      'time': {
          'created': tickets[i]["t_cdate"],
          'modified': tickets[i]["t_mdate"]
      }
    };

    if (tickets[i]["type"]["id"] == "1") {
      contract["tickets"]["connectionRequest"] = {
        'id': tickets[i]["t_id"],
        'color': (tickets[i]["status"]["id"] == 4 ? "green-color" : "red-color fa-blink"),
        'tooltip': tickets[i]["status"]["name"]
      }
    };
  }

  for (var i = 0; i < aboninfo["sms_tmpl_list"].length; i++) {
    tmpl = aboninfo["sms_tmpl_list"][i];
    if (contract['tickets']['selected']) {
      tmpl["s_desc"] = tmpl["s_desc"].replace('XXXXXXXXXX', contract['tickets'][contract['tickets']['selected']]['number']);
    }
    if (tmpl["s_name"] == "[ТП2] Закрытие") {
      contract['sms_templates']['close'] = tmpl;
    } else if (tmpl["s_name"] == "[ТП2] Недозвон") {
      contract['sms_templates']['notavail'] = tmpl;
    } else if (tmpl["s_name"] == "[ТП2] Роутер в СЦ") {
      contract['sms_templates']['router'] = tmpl;
    } else {
      contract['sms_templates']['other'][i] = tmpl;
    }
  }
  return contract;
}

async function resetGT_new(force=false) {
  contract = await resetContract_new(force);
  if (!contract["contract"]["fvno"]) {
    url = '/getnetworkinfo.pl?house='+contract.address.house.id+'&json=1&login='+contract.contract.alias
    gt = await (force ? hd_query_force(url) : hd_query(url))
    contract['greentable'] = {
      'contype': (gt['con_type'] == 'IPOE' ? 'ipoe' : (gt['opt_gate'] && gt['opt_gate'].startsWith("100.") ? 'ipoe' : 'l2tp')),
      'echelon': gt['echelon'] || "0",
      'ip': gt['switch_ip'] || gt['port_sw'] || "0.0.0.0",
      'port': gt['switch_port'] || gt['port_port'] || 0,
      'agg': gt['s_vlan_root_ip'] || gt['opt_root'] || "0.0.0.0",
      'gate': gt['opt_gate'] || 0,
      'dns': gt['dns'] || gt['opt_dns'] || "0.0.0.0 0.0.0.0"
    };
  }
  contract['lastmile'] = {
    'href': (localStorage.operatorGroup == 2) ? 'http://seapig.corbina.net/index2.php?tt='+(contract.tickets.selected == 0 ? "" : contract.tickets[contract.tickets.selected].number)+'&ip='+contract['greentable']['ip']+'&port='+contract['greentable']['port']+'&echelon='+contract['greentable']['echelon'] : (gt['lastmile'] || '/lmdiag/'),
    'name': (localStorage.operatorGroup == 2) ? 'Seapig' : 'Lastmile'
  }
  return contract;
}

async function resetOnline_new(force=false) {
  contract = await resetGT_new(force);
  if (!contract["contract"]["fvno"]) {
    url = '/ptn/main_page/get_network_info/'+contract.address.city.id+'/'+contract.contract.alias
    session = await (force ? hd_query_force(url) : hd_query(url))

    contract['session'] = {
      'sesstype': session['CON_TYPE'].toLowerCase(),
      'online': session['STATUS'],
      'ip': {
        'bras': session['BRAS_IP'],
        'bras_no_policy': bras_no_policy[contract.address.city.id],
        'local': session['CLIENT_IP'],
        'ext': session['FRAMED_IP']
      },
      'time': {
        'start': session['START'],
        'update': session['UPDATE'],
        'duration': dateDiff(new Date(), new Date(session['START']))
      }
    };
    if ('ipoe_client_data' in session) {
      contract['session']['ipoe_data'] = {
        'c_vlan': session['ipoe_client_data']['c_vlan'],
        's_vlan': session['ipoe_client_data']['s_vlan'],
        'mac': session['ipoe_client_data']['mac']
      }
    };

    if (session['STATUS'] == 0) {
      if (!!contract.latest_session) {
        contract['session']['time']['start'] = contract.latest_session;
        d = contract.latest_session.split(' ')[0].split('.');
        let logon_page = await hd_query_force('/showcalls.pl?login='+contract.contract.alias+'&date='+d[2]+'-'+d[1]+'-'+d[0])
        var parser = new DOMParser();
        var page = parser.parseFromString(logon_page, "text/html");
        logins = page.querySelectorAll('a[href^="telnet"]');
        if (logins.length > 0) {
          contract['session']['ip']['bras'] = logins[logins.length-1].innerHTML;
        }
      } else {
        contract['session']['time']['start'] = "Нет информации";
        contract['session']['ip']['bras'] = "0.0.0.0";
      }
    }
  }

  return contract;
}

async function createTT(data) {
  if (data['ticket_comment'] == "") {data['ticket_comment'] = "-"}
  hd_query_force('/ptn/tickets/api/ticket/create', "POST", data).then(function(res) {
    ticket_id = res['result'][0]['t_id']
    window.location.hash = "/abonent/address/"+get_address_id()+"/ticket/"+ticket_id;
    window.location.reload();
  })
}

async function updateTT(ticket_id, data) {
  data['validation'] = false;
  hd_query_force('/ptn/tickets/api/ticket/update/'+ticket_id, "POST", data).then(function(res) {
      window.location.reload()
  });
}

//                                      //
//         Date gen functions           //
//                                      //

function date_morning(tz=0) { // Returns next possible morning (9:00 or 11:00)
    var today = date_now(tz);
    var morning = new Date(today);
    morning.setHours(09);
    morning.setMinutes(00);
    morning.setSeconds(00);
    if (morning < today) {
	// If the morning has passed, add a day (month border safe)
	morning.setMilliseconds(morning.getMilliseconds()+1000*3600*24);
    };
    if ( (1+morning.getDay()) % 7 < 2) {
        morning.setHours(11); // weekend
    }
    morning.setMilliseconds(morning.getMilliseconds()-1000*3600*tz);
    return morning;
}

function date_shift(tz, shift) { // Calculate time in other timezone
	d = date_now(tz);
	d.setHours(d.getHours()+parseInt(shift));
	return d;
}

function date_now(tz=0) { // Get current GMT+3 datetime as GMT+0
	var d = new Date();
	d.setMilliseconds( d.getMilliseconds() + ( d.getTimezoneOffset()+60*(tz+3) )*60000 )
	return d;
}

function datetostr(date, format) { // Convert datetime to needed format
	var year = date.getFullYear();
	var month = date.getMonth()+1;
	var day = date.getDate();
	var hour = date.getHours();
	var minute = date.getMinutes();
	if (format == "sms") {
		return day+"."+month+"."+year+" "+hour+":"+minute
	} else if (format == "tt") {
		return lead0(day)+"."+lead0(month)+"."+year+" "+lead0(hour)+":"+lead0(minute)
	}
}

function strtodate(date_string, date_order=[2, 1, 0], datetime_delimeter=' ', date_delimeter='.', time_delimeter=':') {
  let tmp = date_string.split(datetime_delimeter);
  let date = tmp[0].split(date_delimeter);
  let time = (tmp[1] ? tmp[1].split(time_delimeter) : ['00', '00']);
  return new Date(date[date_order[0]], parseInt(date[date_order[1]])-1, date[date_order[2]], time[0], time[1]);
 }

function dateDiff(date1, date2) { // Returns difference between dates in days, hours, minutes and seconds.
   var res = Math.abs(date1 - date2) / 1000;
   return {
     'd': Math.floor(res / 86400),
     'h': Math.floor(res / 3600) % 24,
     'm': Math.floor(res / 60) % 60,
     's': Math.floor(res % 60)
   }
}

//                                      //
//          Helper functions            //
//                                      //

function lead0(i) {return (i<10)?"0"+i:i}

async function async_querySelector(selector) {
  target = document.querySelector(selector)
  if (target) {
    return target
  } else {
    await sleep(250);
    return async_querySelector(selector);
  }
}

function scrollToElement(e) {
    var h = 0;
    while (e != null) {
        h += e.offsetTop;
        e = e.offsetParent;
    }
    h = (document.body.style.zoom) ? h*document.body.style.zoom : h;
    window.scrollTo(0,h);
}

function addElement(type, id, stl, opt) {
    var f = document.createElement(type);
    if (id) {f.id = id};
    Object.assign(f.style, stl);
    for (var i in opt) {f.setAttribute(i, opt[i])};
    return f;
}

function wrap(el, wrapper) {
    el.parentNode.insertBefore(wrapper, el);
    wrapper.appendChild(el);
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function http_build_query(formdata) {
	var i = 0, tmp_arr = [], arg_separator = '&';

	for(key in formdata){
		use_key = escape(key);
		use_val = escape((formdata[key].toString()));
		use_val = use_val.replace(/%20/g, '+');
		tmp_arr[i] = use_key + '=' + use_val;
		i++;
	}

	return tmp_arr.join(arg_separator);
}

function toggle_window(btn) {
  // Closing all opened frames except one which button clicked
  document.querySelectorAll('i.fa-times').forEach(function(e){btn != e.closest('div') && e.click()});
  document.getElementById(btn.id+'Window').style.display = (btn.firstChild.classList.contains('fa-times') ? "none" : "block");
  btn.firstChild.classList.toggle('fa-times');
  btn.firstChild.classList.toggle('red-color');
  btn.firstChild.classList.toggle(btn.dataset.icon);
}

function init_clipboard() {
  var clipboard = new ClipboardJS('.btnClipboard', {
  	text: function(trigger) {
      if (trigger.value != 'Скопировано!') {return trigger.value}
  	}
  });
  clipboard.on('success', function(e) {
  	if (e.trigger.tagName == 'INPUT' || e.trigger.tagName == 'TEXTAREA') {
  		e.trigger.value = 'Скопировано!';
  		setTimeout(function(){e.trigger.value = e.text}, 750);
  	}
  	e.clearSelection();
  });
}
